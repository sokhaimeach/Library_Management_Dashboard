<div class="container py-4">

  <!-- ======= Header ======= -->
  <div class="topbar p-3 p-md-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">

      <div class="d-flex align-items-center gap-2">
        <div class="topbar-icon">
          <i class="bi bi-arrow-left-right"></i>
        </div>
        <div>
          <div class="fw-bold topbar-title">Borrow / Return</div>
          <div class="text-muted small">Borrow & Return</div>
        </div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <!-- optional actions -->
      </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-pills mt-3 tab-pills" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tabBorrow" type="button">
          <i class="bi bi-journal-plus me-1"></i> Borrow
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabReturn" type="button">
          <i class="bi bi-journal-check me-1"></i> Return
        </button>
      </li>
    </ul>
  </div>

  <div class="tab-content mt-3">

    <!-- ===================== BORROW TAB ===================== -->
    <div class="tab-pane fade show active" id="tabBorrow">
      <div class="row g-3">

        <!-- Left: Member -->
        <div class="col-12 col-lg-4">
          <div class="panel-card h-100">
            <div class="panel-head d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center gap-2">
                <div class="panel-icon">
                  <i class="bi bi-person"></i>
                </div>
                <div class="fw-semibold">Member</div>
              </div>

              <button class="btn btn-sm add-member" data-bs-toggle="modal" data-bs-target="#addMemberModal">
                <i class="bi bi-plus"></i>  Add member
              </button>
            </div>

            <div class="panel-body">
              <label class="form-label small text-muted mb-1">Search member</label>

              <!-- memberQuery -->
              <input class="form-control inputs" type="text" [(ngModel)]="memberQuery" name="memberQuery"
                placeholder="Type name or ID..." />

              <!-- dropdown list -->
              @if(filteredMembers.length){
              <div class="mt-2 list-group border rounded-3 overflow-hidden">
                @for(m of filteredMembers; track m._id){
                <button type="button"
                  class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                  (click)="selectMember(m)">
                  <div>
                    <div class="fw-semibold">{{ m.name }}</div>
                    <div class="small text-muted">{{ m._id }} · {{ m.contact.email || '-' }}</div>
                  </div>

                  <span class="badge rounded-pill"
                    [ngClass]="m.member_type === 'blacklist' ? 'text-bg-danger' : 'text-bg-dark'">
                    {{ m.member_type }}
                  </span>
                </button>
                }
              </div>
              }

              <!-- Selected member -->
              @if(selectedMember){
              <div class="mt-3 detail-box">
                <div class="d-flex justify-content-between gap-2">
                  <div>
                    <div class="fw-semibold text-dark">{{ selectedMember.name }}</div>
                    <div class="sub-text" style="font-size: 12px; color: rgba(0, 0, 0, 0.494);">Id: {{
                      selectedMember._id }}</div>

                    <div class="mt-3">
                      <span class="fw-semibold text-dark">{{ selectedBook?.title }} · </span>
                      <span class="text-dark">{{ selectedBook?.category_name }}</span>
                    </div>
                  </div>

                  <button class="icon-btn btn" type="button" (click)="clearMember()" aria-label="Clear member">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>

                @if(selectedMember.member_type === 'blacklist'){
                <div class="alert alert-danger py-2 px-3 mt-3 mb-0">
                  <i class="bi bi-exclamation-triangle me-1"></i>
                  Blacklist member — cannot borrow.
                </div>
                }

                @if(memberHasActiveBorrow){
                <div class="alert alert-danger py-2 px-3 mt-3 mb-0">
                  <i class="bi bi-exclamation-triangle me-1"></i>
                  This member already borrowed 1 book (active). Must return first.
                </div>
                }
              </div>
              <button class="btn add-member mt-2" style="border-radius: 12px; width: 100%;"
                [disabled]="selectedBook===null? true: false">
                Confirm borrow
              </button>
              } @else {
              <div class="text-muted small mt-3">
                Select a member to borrow.
              </div>
              }
            </div>
          </div>
        </div>

        <!-- Right: Books -->
        <div class="col-12 col-lg-8">
          <div class="panel-card h-100">

            <div class="panel-head d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center gap-2">
                <div class="panel-icon">
                  <i class="bi bi-book"></i>
                </div>
                <div class="fw-semibold">Books</div>
              </div>

              <span class="badge rounded-pill text-bg-light border badge-soft">
                Member can borrow 1 book
              </span>
            </div>

            <div class="panel-body">

              <div class="row g-2 mb-3">
                <div class="col-12 col-md-8">
                  <input class="form-control inputs" type="text" [(ngModel)]="bookQuery" name="bookQuery"
                    placeholder="Search book title / author / category..." />
                </div>

                <div class="col-12 col-md-4">
                  <select class="form-select inputs" [(ngModel)]="availabilityFilter" name="availabilityFilter">
                    <option value="all">All</option>
                    <option value="available">Available only</option>
                  </select>
                </div>
              </div>

              <div class="row g-3">
                @for(b of filteredBooks; track b._id){
                <div class="col-12 col-md-6">
                  <div class="book-mini">
                    <div class="d-flex gap-3">
                      <img [src]="b.cover_url" class="cover" alt="cover">

                      <div class="flex-grow-1">
                        <div class="fw-semibold text-dark">{{ b.title }}</div>
                        <div class="sub-text">{{ b.author_name }} · {{ b.category_name }}</div>

                        <div class="mt-2 d-flex flex-wrap gap-2">
                          <span class="badge rounded-pill text-bg-dark">Available : {{ b.available_copies }}</span>
                          <span class="badge rounded-pill text-bg-light border">
                            ${{ b.price?.$numberDecimal || '-' }}
                          </span>
                        </div>

                        <div class="mt-3 d-flex align-items-center justify-content-between">
                          @if(b.available_copies === 0){
                          <span class="text-danger small">No copies</span>
                          }
                        </div>
                      </div>
                    </div>
                    <button class="btn btn-dark btn-sm" style="border-radius: 8px; width: 100%;" type="button"
                      (click)="borrowBook(b)" [disabled]="!canBorrowThisBook(b)">
                      <i class="bi bi-check2-circle me-1"></i> Select this book
                    </button>
                  </div>
                </div>
                }

                @if(filteredBooks.length === 0){
                <div class="col-12">
                  <div class="text-muted text-center py-5 border rounded-3 bg-white">
                    No books found.
                  </div>
                </div>
                }
              </div>

            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ===================== RETURN TAB ===================== -->
    <div class="tab-pane fade" id="tabReturn">
      <div class="row g-3">

        <!-- Left: Borrow records list -->
        <div class="col-12 col-lg-7">
          <div class="panel-card">
            <div class="panel-head d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center gap-2">
                <div class="panel-icon">
                  <i class="bi bi-list-check"></i>
                </div>
                <div class="fw-semibold">Borrow Records</div>
              </div>

              <span class="badge rounded-pill text-bg-light border badge-soft">
                {{ filteredBorrowRecords.length }} active
              </span>
            </div>

            <div class="panel-body">

              <input class="form-control inputs mb-3" type="text" [(ngModel)]="returnSearch" name="returnSearch"
                placeholder="Search member / book / status / id..." />

              <div class="table-responsive border rounded-3">
                <table class="table align-middle mb-0">
                  <thead class="table-head-light">
                    <tr>
                      <th>Member</th>
                      <th>Book</th>
                      <th>Status</th>
                      <th>Due</th>
                    </tr>
                  </thead>

                  <tbody>
                    @for(r of filteredBorrowRecords; track r._id){
                    <tr class="row-hover" [class.table-active]="selectedBorrow?._id === r._id"
                      (click)="selectBorrowRecord(r)" style="cursor:pointer;">
                      <td class="fw-semibold">{{ r.member_name }}</td>
                      <td>{{ r.book_title }}</td>
                      <td>
                        <span class="badge rounded-pill" [ngClass]="statusBadge(r.status)">{{ r.status }}</span>
                      </td>
                      <td class="text-muted small">{{ r.due_date | date:'mediumDate' }}</td>
                    </tr>
                    }

                    @if(filteredBorrowRecords.length === 0){
                    <tr>
                      <td colspan="5" class="text-center text-muted py-4">No active records</td>
                    </tr>
                    }
                  </tbody>
                </table>
              </div>

              @if(selectedBorrow){
              <div class="detail-box mt-3">
                <div class="fw-semibold text-dark">{{ selectedBorrow.member_name }} · {{ selectedBorrow.book_title }}
                </div>
                <div class="sub-text">
                  Borrow ID: <span class="font-monospace">{{ selectedBorrow._id }}</span>
                </div>
              </div>
              } @else {
              <div class="text-muted small mt-3">
                Select a record to update.
              </div>
              }

            </div>
          </div>
        </div>

        <!-- Right: Quick hint -->
        <div class="col-12 col-lg-5">
          <div class="panel-card h-100">
            <div class="panel-head d-flex align-items-center gap-2">
              <div class="panel-icon">
                <i class="bi bi-arrow-return-left"></i>
              </div>
              <div class="fw-semibold">Update Status</div>
            </div>

            <div class="panel-body">

              <label class="small mb-1 mt-3">Status</label>
              <div class="d-flex flex-wrap gap-2 mb-3">
                @for(s of statuses; track $index){
                <button type="button" class="btn btn-sm" style="border-radius: 8px;" (click)="selectStatus(s)"
                  [ngClass]="updateStatus === s ? 'btn-dark' : 'btn-outline-dark'">
                  {{ s }}
                </button>
                }
              </div>

              @if(updateStatus === 'damaged'){
                <p class="mt-2 mb-1">Damage Type</p>
                <div class="ms-2">
                    <div class="d-flex"></div>
                    <div class="d-flex">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" 
                            name="radioDefault" id="radioDefault1"checked (click)="checkDamageType(true)">
                            <label class="form-check-label" for="radioDefault1">
                                Can use
                            </label>
                        </div>
                        <input type="number" class="form-control ms-2" [disabled]="!isLittleDamage" [(ngModel)]="statusItem.damage_fee"
                    style="width: 140px; height: 30px; border-radius: 8px;" placeholder="Damage fine">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="radioDefault" id="radioDefault2" 
                        (click)="checkDamageType(false)">
                        <label class="form-check-label" for="radioDefault2">
                            Can not use
                        </label>
                    </div>
                </div>

                <div class="alert alert-danger d-flex align-items-center" [ngClass]="removeFailed? 'd-block': 'd-none'"
                    style="width: 100%; height: 30px !important;">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <p class="h-100" style="font-size: 12px;">
                        Invalid damage fine
                    </p>
                </div>
                <div class="mb-3"></div>
              }
              
              <div class="d-flex gap-2 justify-content-start">
                <button class="btn btn-light btn-soft2" type="button" (click)="clearSelectUpdate()">Cancel</button>
                <button class="btn btn-dark btn-save" type="button" (click)="saveStatus()">
                  <i class="bi bi-check2-circle me-1"></i> Save
                </button>
              </div>

              @if(selectedBorrow){
              <div class="detail-box mt-3">
                <div class="fw-semibold text-dark">{{ selectedBorrow.member_name }} · {{ selectedBorrow.book_title }}
                </div>
                <div class="sub-text">
                  Borrow ID: <span class="font-monospace">{{ selectedBorrow._id }}</span>
                </div>
              </div>
              } @else {
              <div class="text-muted small mt-3 w-100">
                Select a record to update.
              </div>
              }
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>



<!-- ======= Modal (Add member) ======= -->
<div class="modal fade" id="addMemberModal" tabindex="-1" aria-labelledby="addMemberModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-soft">
      <div class="modal-body modal-pad">

        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h1 class="modal-title fs-5 fw-bold m-0" id="addMemberModalLabel">Add member</h1>
            <div class="text-muted small">Fill information below</div>
          </div>
          <button type="button" class="btn-close close-modal" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form>
          <div class="row mb-3">
            <div class="col-12">
              <label class="mb-1" for="">Name</label>
              <input type="text" class="form-control inputs" name="memeber_name" [(ngModel)]="memberItem.name">
            </div>
          </div>

          <div class="row mb-5">
            <div class="col-6">
              <label class="mb-1" for="">Phone number</label>
              <input type="text" class="form-control inputs" placeholder="+855" name="phone_number"
                [(ngModel)]="memberItem.contact.phone_number">
            </div>

            <div class="col-6">
              <label class="mb-1" for="">Email</label>
              <input type="email" class="form-control inputs" placeholder="example@gmail.com" name="email"
                [(ngModel)]="memberItem.contact.email">
            </div>
          </div>

          <div class="d-flex w-100 justify-content-end gap-2">
            <button type="button" class="btn btn-light btn-soft2" data-bs-dismiss="modal">
              Cancel
            </button>
            <button type="submit" class="btn btn-dark btn-save">
              <i class="bi bi-check2-circle me-1"></i> Save member
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>
<!-- end::form modal -->


<app-alert-success></app-alert-success>